{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<link rel="stylesheet" href="{% static 'recipes/recipe_detail.css' %}">

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-4 mb-4">

                {% if recipe.image %}
                <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}" class="card-img-top recipe-image">
                {% endif %}

                <div class="card-body p-4">

                    <h1 class="fw-bold mb-3 text-center">{{ recipe.title }}</h1>

                    <p class="text-muted text-center">
                        Posted by
                        <strong>{{ recipe.author.username }}</strong>
                        on {{ recipe.created_at|date:"M d, Y" }}
                    </p>

                    <!-- Save + Unsave Buttons -->
                    {% if user.is_authenticated %}
                    <div class="d-flex justify-content-center gap-2 mb-4 mt-3">
                        <form action="{% url 'toggle_save' recipe.pk %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="save">
                            <button type="submit"
                                class="btn {% if user in recipe.saved_by.all %}btn-outline-secondary{% else %}btn-outline-dark{% endif %} btn-sm">
                                üíæ Save
                            </button>
                        </form>

                        <form action="{% url 'toggle_save' recipe.pk %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="unsave">
                            <button type="submit"
                                class="btn {% if user in recipe.saved_by.all %}btn-outline-danger{% else %}btn-outline-secondary disabled{% endif %} btn-sm">
                                ‚ùå Unsave
                            </button>
                        </form>
                    </div>
                    {% endif %}

                    <hr>

                    <h4 class="mt-4 fw-semibold">Description</h4>
                    <p>{{ recipe.description }}</p>

                    <h4 class="mt-4 fw-semibold">Ingredients</h4>
                    <div class="bg-light p-3 rounded">
                        {{ recipe.ingredients|linebreaks }}
                    </div>

                    <h4 class="mt-4 fw-semibold">Instructions</h4>
                    <div class="bg-light p-3 rounded">
                        {{ recipe.instructions|linebreaks }}
                    </div>

                    <!-- Like Button -->
                    <div class="mt-4 text-center">
                        {% if user.is_authenticated %}
                        <form action="{% url 'recipe_like' recipe.pk %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                ‚ù§Ô∏è {{ recipe.total_likes }}
                            </button>
                        </form>
                        {% else %}
                        <span class="btn btn-outline-secondary btn-sm">
                            ‚ù§Ô∏è {{ recipe.total_likes }}
                        </span>
                        {% endif %}
                    </div>

                    <div class="mt-3 text-center mb-5">
                        <a href="{% url 'recipe_list' %}" class="btn btn-secondary">
                            <i class="fa-solid fa-arrow-left"></i> Back to Recipes
                        </a>
                    </div>

                    <!-- COMMENTS SECTION -->
                    <hr>
                    <h3 class="fw-semibold mb-3">Comments ({{ recipe.comments.count }})</h3>

                    {% if user.is_authenticated %}
                    <!-- Add Comment Form -->
                    <form action="{% url 'add_comment' recipe.pk %}" method="post" class="mb-4">
                        {% csrf_token %}
                        <div class="mb-2">
                            <textarea name="content" class="form-control" rows="3" placeholder="Write a comment..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-secondary btn-sm">Post Comment</button>
                    </form>
                    {% else %}
                    <p class="text-muted">Login to post a comment.</p>
                    {% endif %}

                    <!-- Existing Comments -->
                    <div class="list-group">
                        {% for comment in recipe.comments.all|dictsortreversed:"created_at" %}
                        <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ comment.author.username }}</strong>
                                <small class="text-muted"> ‚Ä¢ {{ comment.created_at|naturaltime }}</small>
                                <p class="mb-0">{{ comment.content }}</p>
                            </div>
                            {% if user == comment.author %}
                            <div>
                                <!-- Delete button -->
                                <form action="{% url 'delete_comment' recipe.pk comment.id %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                        {% empty %}
                        <p class="text-muted">No comments yet. Be the first to comment!</p>
                        {% endfor %}
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
